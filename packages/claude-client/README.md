# Claude Client

A client for interacting with the Claude API to perform autonomous code analysis and modification.

## Features

- Autonomous code analysis and modification using Claude 3.7
- Tool-based interaction with repositories
- Prompt caching for improved performance
- Token usage tracking for cost management
- Support for local testing
- Extensible tool architecture

## Installation

```bash
npm install claude-client
```

## Usage

### Basic Usage

```typescript
import { ClaudeClient } from 'claude-client';

// Initialize the client
const client = new ClaudeClient({
  apiKey: process.env['CLAUDE_API_KEY'],
  model: 'claude-3-7-sonnet-20240229',
  maxTokens: 100000,
  temperature: 0.5
});

// Run an autonomous session
const result = await client.runAutonomousSession(
  '/path/to/repository',
  'Analyze this repository and update any deprecated API calls.',
  10 // Maximum iterations
);

// Print results
console.log(`Session completed after ${result.iterations} iterations`);
console.log(`Complete: ${result.complete}`);
console.log(`Token usage: ${JSON.stringify(result.tokenUsage)}`);
```

### Available Tools

The Claude client provides the following tools for interacting with repositories:

#### ListFilesTool

Lists files in a directory within the repository.

```typescript
// Example input
{
  "directory": "src",
  "pattern": "*.ts" // Optional
}

// Example output
{
  "files": ["file1.ts", "file2.ts"],
  "success": true
}
```

#### ReadFileTool

Reads the contents of a file in the repository.

```typescript
// Example input
{
  "path": "src/main.ts"
}

// Example output
{
  "content": "// File content here",
  "success": true
}
```

#### WriteFileTool

Writes content to a file in the repository. Creates the file if it doesn't exist.

```typescript
// Example input
{
  "path": "src/new-file.ts",
  "content": "// New file content"
}

// Example output
{
  "success": true,
  "message": "File src/new-file.ts written successfully."
}
```

#### SearchCodeTool

Searches for patterns in code using regular expressions.

```typescript
// Example input
{
  "pattern": "deprecated",
  "directory": "src",
  "file_pattern": "*.ts" // Optional
}

// Example output
{
  "results": [
    {
      "file": "src/main.ts",
      "matches": [
        {
          "line": 10,
          "content": "// This API is deprecated"
        }
      ]
    }
  ],
  "success": true
}
```

#### TaskCompleteTool

Indicates that the task is complete and provides a summary of changes made.

```typescript
// Example input
{
  "summary": "Updated deprecated API calls in 3 files",
  "files_modified": ["src/main.ts", "src/utils.ts", "src/api.ts"]
}

// Example output
{
  "success": true,
  "message": "Task marked as complete.",
  "summary": "Updated deprecated API calls in 3 files",
  "files_modified": ["src/main.ts", "src/utils.ts", "src/api.ts"]
}
```

### Testing

To run the test script:

```bash
# Set environment variables
export CLAUDE_API_KEY=your_api_key
export CLAUDE_MODEL=claude-3-7-sonnet-20240229
export CLAUDE_MAX_TOKENS=100000
export CLAUDE_TEMPERATURE=0.5

# Run the test script
nx run claude-client:test
```

You can also pass command-line arguments to the test script:

```bash
nx run claude-client:test -- /path/to/repository "Your prompt here" 5
```

The arguments are:
1. Repository path (default: current directory)
2. Prompt (default: "Analyze this repository and list all the files.")
3. Maximum iterations (default: 10)

## Configuration

The Claude client accepts the following configuration options:

- **apiKey**: Claude API key
- **model**: Claude model to use (e.g., 'claude-3-7-sonnet-20240229')
- **maxTokens**: Maximum number of tokens to generate
- **temperature**: Temperature for generation (0.0 to 1.0)

## Implementation Details

The Claude client uses the Anthropic SDK to interact with the Claude API. It implements a tool-based approach to allow Claude to autonomously explore and modify code repositories.

### Architecture

The client consists of the following components:

- **ClaudeClient**: The main client for interacting with the Claude API
- **ToolRegistry**: A registry of tools that Claude can use
- **Tools**: Individual tools for interacting with the repository
- **ClaudeContext**: Context for tool execution

### Token Usage Tracking

The client tracks token usage to help manage costs. It tracks:

- **Input tokens**: Tokens used for input to Claude
- **Output tokens**: Tokens generated by Claude
- **Cache creation tokens**: Tokens used for creating cache entries
- **Cache read tokens**: Tokens saved by reading from cache

### Autonomous Session Flow

The autonomous session flow works as follows:

1. Initialize the session with a prompt
2. Send the prompt to Claude
3. Claude responds with a message or tool use
4. If Claude uses a tool, execute the tool and send the result back to Claude
5. Repeat until Claude indicates completion or the maximum number of iterations is reached

### Extending with Custom Tools

You can extend the client with custom tools by implementing the `Tool` interface:

```typescript
import { BaseTool } from 'claude-client';
import { z } from 'zod';

export class MyCustomTool extends BaseTool<
  typeof MyCustomTool.inputSchema,
  typeof MyCustomTool.outputSchema
> {
  static inputSchema = z.object({
    // Define input schema
    param1: z.string().describe('Description of param1'),
    param2: z.number().optional().describe('Description of param2')
  });
  
  static outputSchema = z.object({
    // Define output schema
    result: z.string().describe('Description of result'),
    success: z.boolean().describe('Whether the operation was successful')
  });
  
  constructor() {
    super(
      'my_custom_tool',
      'Description of my custom tool',
      MyCustomTool.inputSchema,
      MyCustomTool.outputSchema
    );
  }
  
  async execute(input: z.infer<typeof MyCustomTool.inputSchema>, context: ClaudeContext) {
    // Implement tool execution
    return {
      result: `Processed ${input.param1}`,
      success: true
    };
  }
}

// Register the tool
client.registerTool(new MyCustomTool());
```

## Documentation

For more detailed documentation, see:

- [DESIGN.md](./DESIGN.md): Design decisions and architecture
- [IMPLEMENTATION.md](./IMPLEMENTATION.md): Detailed implementation notes

## License

MIT
